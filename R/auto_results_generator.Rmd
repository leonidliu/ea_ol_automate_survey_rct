---
title: "Auto-Generated Results"
author: "OpenLabs and Empower Analytics"
date: "`r format(Sys.time(), '%B %d, %Y, %I:%M %p')`"
output: 
  html_document:
    code_folding: hide
params:
  title: !r NULL
  survey_id: !r NULL
  api_token: !r NULL
  api_secret: !r NULL
  data_path: !r NULL
  download_data: !r NULL
  delete_data: !r NULL
---

```{r, message = F, warning = F}
library(tidyverse)
library(googlesheets4)
library(Rsurveygizmo)
library(kableExtra)
library(liutils)
library(margins)
library(knitr)
library(broom)
library(mgcv)
library(tictoc)

# Start script timer
tic()

title <- params$title
survey_id <- params$survey_id
api_token <- params$api_token
api_secret <- params$api_secret
data_path <- params$data_path
download_data <- params$download_data
delete_data <- params$delete_data

dv_id <- "18wnfE_kjmUnoiVJefzHzDoHJZ7-iexWosEu8R-8eIxg"
dv_sheet <- "Raw DV Variable Names"
formula_sheet <- "Formulas"
ivs <- c("treatment_openlabs", "potus_trump_biden_voted",
         "potus2016_votechoice_recall4", 
         "ideology_web_randomized", "age", "education_2", 
         "partisanship_web2", "race_civis2_web", "gss_spanking_randomized", 
         "gss_spanking_randomized", "gender")

# machete_id <- "1nr4VNp9h7SLIixQWrhkS_opVaxCS3mE9F2RmNha5ywc"
# machete_sheet <- "National ATEs - KFP"

gs4_deauth()

if (download_data) {
  pullsg(survey_id, api_token, api_secret, completes_only = F) %>%
    mutate(survey_id = survey_id) %>%
    relocate(survey_id) %>%
    write_csv(data_path)
}

df <- read_csv(data_path) %>% 
  rename_with(tolower) %>%
  rename_with(snake_case)

if ("istestdata" %in% names(df)) {
  df <- df %>% filter(istestdata == 0)
}

dvs <- read_sheet(dv_id, dv_sheet) %>%
  mutate(detected = raw_var %in% names(df) & raw_var_push %in% names(df)) %>%
  select(-old_dv_name) %>%
  arrange(dv_name)
dvs_raw <- dvs

dvs <- dvs %>% filter(detected)

formulas <- read_sheet(dv_id, formula_sheet) %>%
  right_join(dvs, by = "dv_name") %>%
  select(dv_name, rhs_formula) %>%
  arrange(dv_name)
```

```{r}
df <- df %>%
  select(one_of("id", "response_id"), 
         status, 
         all_of(ivs), 
         all_of(dvs$raw_var), 
         all_of(dvs$raw_var_push)) %>%
  mutate(across(potus_trump_biden_voted,
                ~case_when(. == "3 - Libertarian Jo Jorgensen" ~ "other",
                           . == "4 - Green Party Candidate Howie Hawkins" ~ "other",
                           . == "5 - Someone else" ~ "other",
                           TRUE ~ potus_trump_biden_voted))) %>%
  filter(!is.na(potus_trump_biden_voted)) %>%
  mutate(treatment_openlabs = relevel(as.factor(treatment_openlabs), 'control'))

if ("dv_biden_app" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(approval_biden_20210205_dv,
                    approval_biden_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_biden_app = 
             coalesce(approval_biden_20210205_dv_recoded,
                      approval_biden_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_biden_app_covid" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(approval_covid_biden_20210205_dv,
                    approval_covid_biden_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_biden_app_covid = 
             coalesce(approval_covid_biden_20210205_dv_recoded,
                      approval_covid_biden_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_biden_app_econ" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(approval_econ_biden_20210205_dv,
                    approval_econ_biden_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_biden_app_econ = 
             coalesce(approval_econ_biden_20210205_dv_recoded,
                      approval_econ_biden_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_biden_fav" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(fav_biden_20210205_dv,
                    fav_biden_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_biden_fav = 
             coalesce(fav_biden_20210205_dv_recoded,
                      fav_biden_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_hr_2024" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(hr_pres_2024_biden_generic_20210205_dv,
                    hr_pres_2024_biden_generic_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_hr_2024 = 
             coalesce(hr_pres_2024_biden_generic_20210205_dv_recoded,
                      hr_pres_2024_biden_generic_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_hr_house_combined" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(hr_house_2022_generic_matchup_20210425_dv,
                    hr_house_2022_generic_matchup_20210425_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_hr_house_combined = 
             coalesce(hr_house_2022_generic_matchup_20210425_dv_recoded,
                      hr_house_2022_generic_matchup_20210425_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_rep_unfav" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(fav_rep_party_20210205_dv,
                    fav_rep_party_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 0,
                                    substr(., 1, 1) == "2" ~ 0,
                                    substr(., 1, 1) == "3" ~ 1,
                                    substr(., 1, 1) == "4" ~ 1,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_rep_unfav = 
             coalesce(fav_rep_party_20210205_dv_recoded,
                      fav_rep_party_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_dem_fav" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(fav_dem_party_20210205_dv,
                    fav_dem_party_20210205_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_dem_fav = 
             coalesce(fav_dem_party_20210205_dv_recoded,
                      fav_dem_party_20210205_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_ajp_support" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(support_ajp_092821_dv,
                    support_ajp_092821_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_ajp_support = 
             coalesce(support_ajp_092821_dv_recoded,
                      support_ajp_092821_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_conf_inst" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(bbt_institutions_090221_dv,
                    bbt_institutions_090221_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 0,
                                    substr(., 1, 1) == "3" ~ 0,
                                    substr(., 1, 1) == "4" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_conf_inst = 
             coalesce(bbt_institutions_090221_dv_recoded,
                      bbt_institutions_090221_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}

if ("dv_soc_trust" %in% dvs$dv_name) {
  
  df <- df %>%
    mutate(across(c(bbt_social_trust_090221_dv,
                    bbt_social_trust_090221_dv_push),
                  list(`recoded` = 
                         ~case_when(substr(., 1, 1) == "1" ~ 1,
                                    substr(., 1, 1) == "2" ~ 1,
                                    substr(., 1, 1) == "4" ~ 0,
                                    substr(., 1, 1) == "5" ~ 0,
                                    TRUE ~ NA_real_)))) %>%
    mutate(dv_soc_trust = 
             coalesce(bbt_social_trust_090221_dv_recoded,
                      bbt_social_trust_090221_dv_push_recoded)) %>%
    select(-ends_with("recoded"))
  
}
```

```{r}
analysis <- df %>%
  pivot_longer(starts_with("dv"), 
               names_to = "dv_name",
               values_to = "dv_value") %>%
  filter(!is.na(dv_value)) %>%
  group_by(dv_name) %>%
  nest() %>%
  left_join(formulas, by = "dv_name") %>%
  mutate(gam_formula = paste("dv_value", rhs_formula),
         gam_formula = list(as.formula(gam_formula))) %>%
  select(-rhs_formula) %>%
  mutate(gam_fit = map2(gam_formula, data, ~gam(.x, data = .y))) %>%
  mutate(data = map2(data, gam_fit, ~mutate(.x, pred = predict(.y, .x)))) %>%
  mutate(lm_formula = "dv_value ~ treatment_openlabs + pred",
         lm_formula = list(as.formula(lm_formula))) %>%
  mutate(lm_fit = map2(lm_formula, data, ~lm(.x, data = .y))) %>%
  mutate(margins = map2(lm_fit, data, 
                        ~summary(margins(.x, .y, "treatment_openlabs")))) %>%
  mutate(glanced = map(lm_fit, glance)) %>%
  unnest(c(margins, glanced)) %>%
  select(dv_name, factor, AME, SE, p, adj_rsq = adj.r.squared, n = nobs) %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  arrange(dv_name, factor)
```

`r title`
=========

# Inputs

| Parameter        | Value                                 |
|------------------|---------------------------------------|
| *survey_id*:     | `r format(survey_id, scientific = F)` |
| *data_path*:     | `r data_path`                         |
| *download_data*: | `r download_data`                     |
| *delete_data*:   | `r delete_data`                       |
| *api_token*:     | (hidden)                              |
| *api_secret*:    | (hidden)                              |

# Descriptives

| Parameter             | Value         |
|-----------------------|---------------|
| *num_rows*:           | `r nrow(df)`  |
| *num_cols*:           | `r ncol(df)`  |
| *num_detected_dvs*:   | `r nrow(dvs)` |

# Detected DVs

```{r}
dvs_raw %>% kable() %>% kable_styling(full_width = TRUE)
```

# Results

```{r}
analysis %>% kable() %>% kable_styling(full_width = TRUE)
```

# Appendix

## Summary of missingness

```{r, warning = F}
df %>% map(~sum(is.na(.x))) %>% bind_rows() %>% t()
```

## Check DV recoding

```{r}
check_recode <- function(dv_name, raw_var) {
  list(dv = dv_name, recode = table2(df[[raw_var]], df[[dv_name]]))
}

map2(dvs$dv_name, dvs$raw_var, check_recode)
```

## Check formulas

```{r}
formulas %>% kable() %>% kable_styling(full_width = TRUE)
```

## Data peek

```{r}
glimpse(df)
```

## (Internal) Delete data if requested

```{r}
if (delete_data) file.remove(data_path)
```

## (Internal) Script timer

```{r}
toc()
```
